package DesignPattern.Proxy.n_proxy.d;

import java.lang.reflect.InvocationHandler;
import java.lang.reflect.Method;
import java.lang.reflect.Proxy;
import java.util.Arrays;

/**
 * ä¸ºäº†è§£å†³ c åŒ…ä¸­çš„é—®é¢˜,æˆ‘ä»¬å¿…é¡»å­¦ä¹ ä¸€ä¸ª jdk ä¸­çš„ api: åŠ¨æ€ä»£ç†.
 */
interface ICalc {
    int add(int a, int b); //åŠ 
    int sub(int a, int b); //å‡
    int mul(int a, int b); //ä¹˜
    int div(int a, int b); //é™¤
}

class CalcImpl implements ICalc {

    @Override
    public int add(int a, int b) {
        int r = a + b;
        return r ;
    }

    @Override
    public int sub(int a, int b) {
        int r = a - b ;
        return r;
    }

    @Override
    public int mul(int a, int b) {
        int r = a * b;
        return r;
    }

    @Override
    public int div(int a, int b) {
        int r = a / b;
        return r;
    }
}

//=======================æ—¶ç©ºçº¿================================


public class AppTest {
    public static void main(String[] args) {
        /** åŠ¨æ€ä»£ç†:è¿™ä¸ªè§†é¢‘çš„16åˆ†é’Ÿå¼€å§‹:
         https://www.bilibili.com/video/BV1Qx411o7tN?p=38&spm_id_from=pageDriver&vd_source=b386945edbef32fc1df7d8a419f8de78
         */

        /**
         * å¦‚ä½•åˆ›å»ºä¸€ä¸ªåŠ¨æ€ä»£ç†:
         * Proxy.newProxyInstance() éœ€è¦å‡ ä¸ªå‚æ•°:
         * 1.ClassLoader loader, ç±»åŠ è½½å™¨
         * 2.Class<?>[] interfaces, å­—èŠ‚ç æ•°ç»„.
         * 3.InvocationHandler h
      å‚æ•°1:ç±»åŠ è½½å™¨: é€šè¿‡å½“å‰ç±»çš„å­—èŠ‚ç :è·å–åˆ°åŠ è½½è¿™ä¸ªç±»çš„å­—èŠ‚ç çš„ç±»åŠ è½½å™¨.
         * ä¸ºä½•è¦è·å–ç±»åŠ è½½å™¨:æˆ‘ä»¬çŸ¥é“è¦å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡,å°±å¿…é¡»è°ƒç”¨ç±»çš„æ„é€ å™¨,
         * åœ¨æ„é€ å™¨è°ƒç”¨ä¹‹å‰,jvm å°±ä¼šåŠ è½½è¯¥ç±»çš„å­—èŠ‚ç !
         * jvm æ°æ°å°±æ˜¯ç”¨ "ç±»åŠ è½½å™¨" æ¥åŠ è½½ç±»çš„å­—èŠ‚ç çš„. è¿™ä¸€æ­¥æ˜¯jvmè‡ªåŠ¨å®Œæˆçš„.
         * ä»¥ä¸‹ä»£ç æ˜¯åŠ¨æ€åˆ›å»ºä¸€ä¸ªä»£ç†å¯¹è±¡çš„ä»£ç ,å¯ä»¥è¯´æ˜¯ä¸€ç§ä¸å¤ªæ­£å¸¸çš„åˆ›å»ºå¯¹è±¡çš„æ–¹å¼,å°±ç®—ä¸æ­£å¸¸,æ¯•ç«Ÿä¹Ÿæ˜¯è¦åˆ›å»ºå¯¹è±¡çš„å˜›~.
         * ä½†å‡¡åˆ›å»ºå¯¹è±¡,åŠ¿å¿…è¦åŠ è½½å­—èŠ‚ç ,åŠ¿å¿…å°±è¦ä½¿ç”¨ç±»çš„ç±»åŠ è½½å™¨,
         * å’Œæ„é€ å™¨å®ä¾‹åŒ–ä¸åŒçš„æ˜¯:ä½¿ç”¨æ„é€ å™¨å®ä¾‹åŒ–å¯¹è±¡æ—¶,jvmä¼šè‡ªåŠ¨æ‰¾åˆ°ç±»çš„åŠ è½½å™¨,è€Œä»¥ä¸‹ä»£ç ,å¿…é¡»æˆ‘ä»¬æ‰‹åŠ¨ä¼ å…¥ç±»çš„åŠ è½½å™¨.
         *
      å‚æ•°2: 2.Class<?>[] interfaces, å­—èŠ‚ç æ•°ç»„.
         æˆ‘ä»¬éƒ½çŸ¥é“,è¦åˆ›å»ºä¸€ä¸ªç±»çš„å¯¹è±¡,å¿…é¡»è¦å…ˆåŠ è½½ç±»çš„å­—èŠ‚ç ,é‚£ä¹ˆåŠ¨æ€ä»£ç†ä¹Ÿä¸ä¾‹å¤–,æ‰€ä»¥æˆ‘ä»¬æ‰ä¼ å…¥ç¬¬ä¸€ä¸ªå‚æ•°:ç±»åŠ è½½å™¨!
         é—®é¢˜æ˜¯:è¿™ä¸ªä¼ å…¥çš„ç±»åŠ è½½å™¨,åŠ è½½çš„æ˜¯å“ªä¸ªç±»çš„å­—èŠ‚ç ??
         å¯¹æ¯”:
         æˆ‘ä»¬å¹³æ—¶ä½¿ç”¨ new æ„é€ å™¨ çš„æ–¹å¼åˆ›å»ºå¯¹è±¡:
         new String();      jvm å°±ä¼šåŠ è½½String.class
         new Date();        jvm å°±ä¼šåŠ è½½Date.class
         new ArrayList();   jvm å°±ä¼šåŠ è½½ArrayList.class
         é€šè¿‡ new XXX() æ˜¯èƒ½æ˜ç¡®çŸ¥é“è¦åŠ è½½é‚£ä¸ªç±»çš„å­—èŠ‚ç çš„.
         ä½¿ç”¨åŠ¨æ€ä»£ç†apiåˆ›å»ºå¯¹è±¡æ—¶,åŠ è½½å“ªä¸ªå­—èŠ‚ç å‘¢? - çœ‹JVMå›¾è§£é‡Š å’Œ åç¼–è¯‘æŸ¥çœ‹å­—èŠ‚ç é‡Œæ˜¯ä»€ä¹ˆ?
         é™æ€è·å¾—å­—èŠ‚ç :æºç -ç¼–è¯‘-ç”Ÿæˆå­—èŠ‚ç .
         åŠ¨æ€:
         å¦‚æœç°åœ¨ç”¨åŠ¨æ€ä»£ç†æ–¹å¼åˆ›å»º,é‚£ä¹ˆè¦åŠ è½½çš„å­—èŠ‚ç åœ¨å“ªé‡Œä¹ˆ? å°±æ˜¯é€šè¿‡ç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥.
         ä½¿ç”¨åŠ¨æ€ä»£ç†apiåˆ›å»ºå¯¹è±¡æ—¶åŠ è½½çš„å­—èŠ‚ç å°±ä¼šåœ¨è¿è¡ŒæœŸåŠ¨æ€ç”Ÿæˆçš„å­—èŠ‚ç ,è¿™åŠ¨æ€ç”Ÿæˆçš„å­—èŠ‚ç æ˜¯ä¸éœ€è¦æºä»£ç çš„.
         é—®é¢˜æ˜¯:å­—èŠ‚ç ç¡®å®å¯ä»¥è‡ªåŠ¨ç”Ÿæˆ,é‚£ä¹ˆåŠ¨æ€ä»£ç†apiåŠ¨æ€ç”Ÿæˆçš„å­—èŠ‚ç çš„å†…å®¹,æ˜¯æ ¹æ®ä»€ä¹ˆç”Ÿæˆå‘¢?
         è¿™æ°æ°å°±æ˜¯æ ¹æ®ç¬¬äºŒä¸ªå‚æ•°ç”Ÿæˆçš„!!å­—èŠ‚ç æ•°ç»„.
         åŠ¨æ€ä»£ç†,ä¼šç”Ÿæˆä¸€ä¸ªå®ç°äº†ç›®æ ‡æ¥å£çš„ç±»çš„å­—èŠ‚ç ,åœ¨æœ¬ä¾‹ä¸­,å°±æ˜¯ç”Ÿæˆä¸€ä¸ªå®ç°äº†ICalcæ¥å£çš„ç±» çš„å­—èŠ‚ç !

         PS:åå°„æ˜¯åœ¨è¿è¡ŒæœŸæ ¹æ®å­—èŠ‚ç æ–‡ä»¶ æ¥åæ¨å‡ºç±»çš„ å­—æ®µå±æ€§ æ–¹æ³•,æ„é€ å™¨ ç­‰ç­‰. é€šè¿‡åç¼–è¯‘å­—èŠ‚ç å¯ä»¥çœ‹å‡ºç±»ç»“æ„ä¿¡æ¯.

     å‚æ•°3:è°ƒç”¨å¤„ç†å™¨,InvocationHandler
         æˆ‘ä»¬å·²ç»çŸ¥é“,åŠ¨æ€ä»£ç†ä¼šåŠ è½½è‡ªå·±åŠ¨æ€ç”Ÿæˆçš„å­—èŠ‚ç ,ä¸”è¿™ä¸ªå­—èŠ‚ç æ˜¯æ ¹æ®æŸä¸ªæ¥å£ç”Ÿæˆçš„,
         åœ¨æœ¬ä¾‹ä¸­å°±æ˜¯æ ¹æ®ICalcæ¥å£ç”Ÿæˆçš„å®ç°äº†ICalcæ¥å£çš„ç±»çš„å­—èŠ‚ç .
         é—®é¢˜æ˜¯:å®ç°äº†ä¸€ä¸ªæ¥å£,å°±è¦å®ç°å…¶ä¸­çš„æŠ½è±¡æ–¹æ³•,é‚£ä¹ˆåŠ¨æ€ä»£ç†ç”Ÿæˆçš„å­—èŠ‚ç ,å®ç°äº†ICalcæ¥å£,åŠ¿å¿…å°±è¦å®ç°å…¶ä¸­çš„ add sub mul div æ–¹æ³•!
         è¿™äº›æ–¹æ³•è¢«å®ç°çš„æ–¹æ³•ä½“éƒ½æ˜¯ä»€ä¹ˆå†…å®¹å‘¢? è¿™æ°æ°æ˜¯ç”±ç¬¬3ä¸ªå‚æ•°å†³å®šçš„.MyHandler ç±»çš„ invoke å°±æ˜¯æ–¹æ³•ä½“çš„å†…å®¹,å¯ä»¥è¿™æ ·ç†è§£:
         ä¼ªä»£ç å¤§è‡´å¦‚ä¸‹:
         class æˆ‘æ˜¯åŠ¨æ€ç”Ÿæˆçš„é‚£ä¸ªç±» implements ICalc {
             InvocationHandler handler = åˆ›å»ºæ—¶ç¬¬ä¸‰ä¸ªå‚æ•°ä¼ ç»™å®ƒ.
             //æ¥å£ä¸­çš„æ–¹æ³•ä½“å¤§è‡´æ˜¯å¦‚ä¸‹:
             add() {
                handler.invoke();
             }
             sub() {
                handler.invoke();
             }
             mul() {
                handler.invoke();
             }
             div() {
                handler.invoke();
             }

         }

         */

        //å‚æ•°1:
        ClassLoader classLoader = AppTest.class.getClassLoader();
        //å‚æ•°2
        Class[] interfaces = {ICalc.class};

        //å‚æ•°3 å†³å®šæ–¹æ³•ä½“.

        //è¿™ç§newçš„å«åšçœŸå®å¯¹è±¡,ä¹Ÿå«ç›®æ ‡å¯¹è±¡.
        ICalc calc = new CalcImpl();

        //ç”Ÿæˆä»£ç†å¯¹è±¡:
        ICalc  proxy = (ICalc) Proxy.newProxyInstance(classLoader, interfaces, new MyHandler(calc));
        //å¯¹ä»£ç†å¯¹è±¡çš„æ–¹æ³•è°ƒç”¨,éƒ½ä¼šç»Ÿç»Ÿè¿›å…¥åˆ°è°ƒç”¨å¤„ç†å™¨ä¸­çš„invokeæ–¹æ³•ä¸­.è€Œä¸ä¼šç›´æ¥è¿›å…¥çœŸå®çš„æ–¹æ³•
        proxy.add(1, 2);
        proxy.sub(1, 2);
        proxy.mul(2, 2);
        proxy.div(100, 25);

    }
}
/**
å‚æ•°3
 */
class MyHandler implements InvocationHandler {

    private  ICalc target;

    MyHandler(ICalc target) {
        this.target = target;
    }

    /** invoke æ–¹æ³•çš„ä¸‰ä¸ªå‚æ•°æ˜¯ä»€ä¹ˆå‘¢?
     *  proxy.add(1, 2);
     *  å‚æ•°1:proxy
     *  å‚æ•°2:é€šè¿‡åå°„æœºåˆ¶ä¼ å…¥ addæ–¹æ³•å¯¹è±¡
     *  å‚æ•°3,æ–¹æ³•çš„å‚æ•°.

     */
    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {

        // testParameterFunction(proxy,method,args);

        System.out.println(method.getName() + " æ–¹æ³•å¼€å§‹,å‚æ•°æ˜¯: " + Arrays.toString(args));
        /// è¿™é‡Œæ‰æ˜¯çœŸå®çš„è°ƒç”¨äº†çœŸå®å¯¹è±¡çš„ä¸šåŠ¡æ–¹æ³•:
        // åˆ©ç”¨åå°„æœºåˆ¶,è°ƒç”¨çœŸå®çš„æ–¹æ³•!!!
        // æŠŠmethodæ‰€ä»£è¡¨çš„æ–¹æ³•,å½“åšæ˜¯ calcæ˜¯çœŸå®å¯¹è±¡çš„æ–¹æ³•è°ƒç”¨,å‚æ•°æ˜¯args.
        // ps:å‚æ•°proxyâŒ åœ¨è¿™é‡Œæ²¡ç”¨,çœŸå®å¯¹è±¡æ˜¯éœ€è¦å¤–é¢ä¼ å…¥çš„ æ‰€ä»¥éœ€è¦åœ¨æ„é€ å™¨ä¸­ä¼ å…¥ä¿å­˜ä½.çœŸå®çš„ä¸šåŠ¡é€»è¾‘åœ¨ çœŸå®å¯¹è±¡çš„ åŠ å‡ä¹˜é™¤ä¸­çš„.
        Object result = method.invoke(target, args);

        System.out.println(method.getName() + " æ–¹æ³•ç»“æŸ,ç»“æœæ˜¯ " + result);

        //PS:è¿™é‡Œçš„è¿”å›å€¼è¦å’Œ æ¥å£ä¸­çš„æ–¹æ³•è¿”å›ä¸€è‡´,
        return result; //è¿™é‡Œçš„è¿”å›å€¼ ä¼šè¿”å›åˆ° ä»£ç†å¯¹è±¡è°ƒç”¨å¤„.
    }

    /**
     * æµ‹è¯• invoke å‚æ•°çš„ä½œç”¨çš„.
     */
    private void testParameterFunction(Object proxy, Method method, Object[] args) {
        System.out.println("MyHandler å‘µå‘µå‘µğŸ™‚");
        String name = method.getName();
        System.out.println("æ–¹æ³•å: " + name + " å‚æ•°: " + Arrays.toString(args));
    }
}

/**
 * ä¼˜ç‚¹:
 * å…‹æœäº†ä¸Šä¸ªåŒ…ä¸­ç¼ºç‚¹.
 * éœ€æ±‚å˜æ›´ åªéœ€è¦è¯¥ä¸€ä¸ªåœ°æ–¹,æ¯”å¦‚è‹±æ–‡å†™æ—¥å¿—. 135ä¸­æ–‡ 246 è‹±æ–‡ é…åˆç­–ç•¥æ¨¡å¼ å¾ˆå¥½æ”¹åŠ¨.
 */
